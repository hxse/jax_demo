# JAX 中实现动态参数技术指标的通用模式

在 JAX 中，要让技术指标的参数（如 `period`）保持动态，我们通常会采用以下几种函数式编程模式：

## 1. 累积聚合法 (Cumulative Aggregation)

* **适用场景**：需要计算固定长度窗口内的**和、平均值、最大值、最小值、标准差**等指标。
* **原理**：先计算整个序列的累积和、累积计数、累积最大/最小值、累积平方和等。然后，通过对这些累积序列进行**索引差分**来获得任意动态窗口内的聚合结果。
* **关键 JAX 函数**：`jnp.cumsum()`, `jnp.cummax()`, `jnp.cummin()`, 数组索引 (`[]`), `jnp.where()`, `jnp.concatenate()`, `jnp.arange()`, `jnp.maximum()`, `jnp.minimum()`。

## 2. `jax.lax.scan` 状态传递法 (State Passing with Scan)

* **适用场景**：指标的计算具有**强烈的序列依赖性**，每个点的结果依赖于前一个点的复杂状态，但**每次迭代的 `carry`（状态）的结构和形状是固定不变的**（例如，几个标量组成的元组，或固定大小的数组）。
* **原理**：`scan` 会在每次迭代中传递和更新一个**固定形状**的 `carry`。动态参数（如 `period`）在 `scan_body` 函数内部作为**数值**参与计算或条件判断，但不会改变 `carry` 的形状。
* **关键 JAX 函数**：`jax.lax.scan()`, `jnp.where()`, 各种算术和比较操作。

## 3. 逐点/逐 K 线条件判断与模式匹配 (Point/Candle-wise Pattern Matching)

* **适用场景**：识别单个 K 线或少数几根 K 线组成的形态。
* **原理**：直接对 K 线数据（开盘、高点、低点、收盘）进行逐点或小窗口内的比较和逻辑组合。
* **关键 JAX 函数**：`jnp.where()`, 各种比较操作 (`jnp.greater`, `jnp.less`, `jnp.equal`), `jnp.logical_and`, `jnp.logical_or`，数组切片 (`[:, i]`)。
* **备注**：这类指标通常**不涉及 `period` 等时间周期参数**，因为它们关注的是瞬时或极短期的 K 线关系。

---

# 常见技术指标及其 JAX 实现模式总结

## 趋势指标

* **SMA** (简单移动平均)
    * **核心计算**：固定窗口内的平均值
    * **推荐模式**：**累积聚合法** (`jnp.cumsum`)
    * **备注**：`period` 可以动态。避免 `jnp.full(period, ...)`。
* **EMA** (指数移动平均)
    * **核心计算**：递归平滑平均
    * **推荐模式**：**`scan` 状态传递法**
    * **备注**：`scan` 的 `carry` 为标量 (上一个 EMA 值)。`period` 动态影响平滑乘数，不影响 `carry` 形状。
* **RMA** (相对移动平均)
    * **核心计算**：类似 EMA 的递归平滑
    * **推荐模式**：**`scan` 状态传递法**
    * **备注**：`scan` 的 `carry` 为 (prev_rma, count, sum_for_initial_avg)，形状固定。`period` 可以动态。
* **WMA** (加权移动平均)
    * **核心计算**：固定窗口内的加权平均值
    * **推荐模式**：**累积聚合法** (累积加权和)
    * **备注**：类似 SMA，权重计算依赖 `period`，但权重数组的创建和累积过程可以处理动态 `period`。
* **HMA** (赫尔移动平均)
    * **核心计算**：WMA 的组合
    * **推荐模式**：**依赖动态 WMA**
    * **备注**：HMA 是 WMA 的组合应用，如果 WMA 可以动态，则 HMA 也可动态。`period` 可以动态。
* **Supertrend**
    * **核心计算**：结合 ATR 的趋势指标
    * **推荐模式**：**`scan` 状态传递法**
    * **备注**：`scan` 的 `carry` 存储当前趋势、ATR 值、上下带等固定结构信息。`period` 和 `multiplier` 都可以动态。
* **PSAR** (抛物线转向)
    * **核心计算**：状态依赖性强的转向指标
    * **推荐模式**：**`scan` 状态传递法**
    * **备注**：`scan` 的 `carry` 存储当前 SAR 值、方向、加速因子等固定结构信息。所有参数在 `scan_body` 内部都只参与数值计算。参数可以动态。

## 动量指标

* **RSI** (相对强弱指数)
    * **核心计算**：基于 RMA 的价格动量
    * **推荐模式**：**依赖动态 RMA**
    * **备注**：既然 RMA 可动态，RSI 也可动态。`period` 可以动态。
* **MACD** (移动平均汇聚背离)
    * **核心计算**：多个 EMA 的组合
    * **推荐模式**：**依赖动态 EMA**
    * **备注**：MACD 是 EMA 的应用，只要 EMA 参数动态，MACD 也动态。所有 `period` 参数都可以动态。
* **ROC** (变动率)
    * **核心计算**：价格在周期内的变化率
    * **推荐模式**：**数组索引**
    * **备注**：`jnp.roll` 或直接索引 (`[i - period]`) 获取历史值，`period` 只是索引的数值，不影响形状。`period` 可以动态。
* **Momentum** (动量)
    * **核心计算**：价格变化量
    * **推荐模式**：**数组索引**
    * **备注**：(当前收盘价 - N 周期前收盘价)。与 ROC 类似，`period` 仅作为数值索引。`period` 可以动态。
* **Williams %R**
    * **核心计算**：价格相对于高低点的相对位置
    * **推荐模式**：**累积聚合法**
    * **备注**：需在动态窗口内查找最高/最低价，可通过类似 SMA 的累积聚合思想实现，或 `scan` 维护窗口内极值（确保 `carry` 形状固定）。`period` 可以动态。
* **CCI** (商品通道指数)
    * **核心计算**：价格偏离平均值的程度
    * **推荐模式**：**累积聚合法**
    * **备注**：涉及 SMA (动态) 和平均绝对偏差 (可基于累积求和实现)。`period` 可以动态。
* **ADX** (平均方向性指数)
    * **核心计算**：多步平滑的动量指标
    * **推荐模式**：**依赖动态 RMA/EMA**
    * **备注**：涉及多个 RMA/EMA 的平滑步骤，如果它们能动态，ADX 也能动态。`period` 可以动态。
* **KDJ** (随机指标)
    * **核心计算**：基于最高最低和收盘价的平滑
    * **推荐模式**：**累积聚合法 + `scan` 状态传递法**
    * **备注**：计算 N 周期内最高/最低价可使用累积聚合。K、D、J 线的平滑可使用 EMA (`scan`)。`period` 可以动态。

## 波动率指标

* **ATR** (平均真实波动范围)
    * **核心计算**：真实波幅 (TR) 的 EMA/SMA 平滑
    * **推荐模式**：**依赖动态 EMA/SMA**
    * **备注**：TR 是逐点计算，然后进行平滑。`period` 可以动态。
* **布林带** (Bollinger Bands)
    * **核心计算**：SMA 和标准差
    * **推荐模式**：**累积聚合法**
    * **备注**：SMA 已经可以动态。标准差 (`jnp.std`) 可以通过累积平方和和累积计数来实现动态窗口计算。`period` 和 `std_multiplier` 都可以动态。
* **肯特纳通道** (Keltner Channels)
    * **核心计算**：EMA 和 ATR 的组合
    * **推荐模式**：**依赖动态 EMA/ATR**
    * **备注**：如果 EMA 和 ATR 可以动态，则肯特纳通道可动态。所有 `period` 参数都可以动态。

## 成交量指标

* **CMF** (Chaikin Money Flow)
    * **核心计算**：资金流量的累积
    * **推荐模式**：**累积聚合法**
    * **备注**：与 SMA 类似，累积资金流量和累积成交量，然后进行窗口计算。`period` 可以动态。
* **VWAP** (成交量加权平均价)
    * **核心计算**：价格和成交量的加权平均
    * **推荐模式**：**累积聚合法**
    * **备注**：累积 `(价格 * 成交量)` 和累积 `成交量`，然后进行比值。`period` 可以动态（如果周期不是指日内）。
* **MFI** (资金流向指数)
    * **核心计算**：结合成交量的资金流指标
    * **推荐模式**：**累积聚合法 + 依赖动态 RMA/EMA**
    * **备注**：类似 RSI，涉及资金流的正负累积和 RMA/EMA 平滑。`period` 可以动态。
* **OBV** (能量潮)
    * **核心计算**：累积成交量
    * **推荐模式**：**`scan` 状态传递法**
    * **备注**：典型的状态依赖性指标，`scan` 的 `carry` 仅为一个标量 (OBV 值)，不依赖周期。

## 波峰波谷/结构指标

* **ZigZag**
    * **核心计算**：过滤后的关键高点和低点
    * **推荐模式**：**`scan` 状态传递法**
    * **备注**：`scan` 的 `carry` 存储当前趋势、上一个拐点、当前波段极值等固定结构信息。`reversal_percentage` 等参数只参与数值计算和条件判断。`reversal_percentage` 可以动态。
* **基于ZigZag的百分比回撤**
    * **核心计算**：在 ZigZag 识别的波段上计算回撤水平
    * **推荐模式**：**数组索引 + 数值计算**
    * **备注**：依赖 ZigZag 输出的高低点。计算是基于这些点的简单比率。不涉及 `period` 参数。

## 价格水平指标

* **枢轴点** (Pivot Points)
    * **核心计算**：基于前一日高低收盘价的支撑阻力位
    * **推荐模式**：**简单算术运算**
    * **备注**：这些是基于历史 K 线（通常是前一日）的固定计算，不涉及 `period` 参数。
* **斐波那契回撤** (Fibonacci Retracement Levels)
    * **核心计算**：基于波段高低点的回撤水平
    * **推荐模式**：**简单算术运算**
    * **备注**：依赖明确的高点和低点（可由 ZigZag 识别），然后进行百分比计算。不涉及 `period` 参数。

## K线形态指标

* **吞噬模式** (Engulfing Pattern)
    * **核心计算**：比较两根 K 线的实体和影线
    * **推荐模式**：**逐点/逐 K 线条件判断与模式匹配**
    * **备注**：比较当前 K 线和前一根 K 线的开/高/低/收。不涉及 `period` 参数。
* **锤子线** (Hammer) / **倒锤子线** (Inverted Hammer)
    * **核心计算**：单根 K 线的特征识别
    * **推荐模式**：**逐点/逐 K 线条件判断与模式匹配**
    * **备注**：判断单根 K 线实体大小、影线长度等。不涉及 `period` 参数。
* **射击之星** (Shooting Star)
    * **核心计算**：单根 K 线的特征识别
    * **推荐模式**：**逐点/逐 K 线条件判断与模式匹配**
    * **备注**：类似锤子线，判断 K 线的上影线长、实体小、下影线短等。不涉及 `period` 参数。
* **晨星** (Morning Star) / **黄昏星** (Evening Star)
    * **核心计算**：三根 K 线的组合模式
    * **推荐模式**：**逐点/逐 K 线条件判断与模式匹配**
    * **备注**：涉及三根 K 线之间的开/高/低/收关系。不涉及 `period` 参数。
* **十字星** (Doji)
    * **核心计算**：单根 K 线的特征识别
    * **推荐模式**：**逐点/逐 K 线条件判断与模式匹配**
    * **备注**：开盘价和收盘价非常接近。不涉及 `period` 参数。
* **乌云盖顶** (Dark Cloud Cover)
    * **核心计算**：两根 K 线的组合模式
    * **推荐模式**：**逐点/逐 K 线条件判断与模式匹配**
    * **备注**：涉及两根 K 线之间的开/高/低/收关系。不涉及 `period` 参数。
* **刺透模式** (Piercing Pattern)
    * **核心计算**：两根 K 线的组合模式
    * **推荐模式**：**逐点/逐 K 线条件判断与模式匹配**
    * **备注**：涉及两根 K 线之间的开/高/低/收关系。不涉及 `period` 参数。
* **三白兵** (Three White Soldiers) / **三只乌鸦** (Three Black Crows)
    * **核心计算**：三根 K 线的组合模式
    * **推荐模式**：**逐点/逐 K 线条件判断与模式匹配**
    * **备注**：涉及三根 K 线连续的阳线/阴线，以及其相对大小和收盘价。不涉及 `period` 参数。

## 基于ZigZag的形态识别

* **头肩顶/底** (Head and Shoulders)
    * **核心计算**：基于 ZigZag 识别的高低点序列模式
    * **推荐模式**：**`scan` 状态传递法 + 模式匹配**
    * **备注**：遍历 ZigZag 输出的高低点序列，`scan` 的 `carry` 存储形态匹配的中间状态。参数（如肩部/头部相对高度、颈线容忍度）可以动态。
* **双顶/双底** (Double Top/Bottom)
    * **核心计算**：基于 ZigZag 识别的高低点序列模式
    * **推荐模式**：**`scan` 状态传递法 + 模式匹配**
    * **备注**：类似头肩顶，在 ZigZag 输出的高低点序列中寻找特定模式。参数可以动态。
* **三重顶/底** (Triple Top/Bottom)
    * **核心计算**：基于 ZigZag 识别的高低点序列模式
    * **推荐模式**：**`scan` 状态传递法 + 模式匹配**
    * **备注**：类似双顶/底，寻找三个近似高度的高点/低点。参数可以动态。
